user  nginx;
#worker_processes  8;
worker_processes auto;

worker_rlimit_nofile 65535;  

error_log  /home/logs/nginx/error.log warn;
error_log  /dev/null;
#pid        /var/run/nginx.pid;
pid        /usr/local/nginx/logs/nginx.pid;


events {
    worker_connections  65535;
	multi_accept on;  
	use epoll; 
}

http {
    include       /usr/local/nginx/conf/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /home/logs/nginx/access.log  main;
  #  access_log  /dev/null;
    sendfile        on;
	server_tokens off;
    keepalive_timeout  65;
	
	#keepalive_timeout 300;
	#keepalive_requests 1000;
	#expires 7d ; #开启cookie丢失问题
	client_max_body_size 4m;
	
	tcp_nopush on;  
	tcp_nodelay on;
	etag on;
	reset_timedout_connection on; 
	gzip on;  
	gzip_disable "msie6";  
	gzip_static on;  
	gzip_proxied any;	
	gzip_min_length 1000;  
	gzip_comp_level 8; 
	gzip_vary on;
	gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    
	include /usr/local/nginx/conf/conf.d/*.conf;

	include /usr/local/nginx/conf/others.conf;
	
	
	#缓存
	proxy_buffering on;
	proxy_buffer_size   16k;
	proxy_buffers   4 64k;
	proxy_busy_buffers_size 128k;
	proxy_temp_file_write_size 128k;
	proxy_cache_valid any 10m;
	proxy_cache_path /home/cache/nginx/ levels=1:2 keys_zone=imgcache:2048m inactive=1d max_size=20g;
	proxy_temp_path  /home/cache/nginx/proxy_temp_dir; 
	

	#前台网站
	server{  
		listen       80;  
		server_name  www.xianghuo.me xianghuo.me ;
		
		if ($host = 'www.xianghuo.me' ) {
			rewrite ^/(.*)$ http://m.xianghuo.me/$1 permanent;
		}		

		if ($host = 'xianghuo.me' ) {
			rewrite ^/(.*)$ http://m.xianghuo.me/$1 permanent;
		}
	} 		
	
	

	#企业形象网站
	server{  
		listen       80; 
		server_name www.haoxianghuo.me haoxianghuo.me;
		include /usr/local/nginx/conf/errorpages.conf;
		
		if ($host = 'haoxianghuo.me' ) {
			rewrite ^/(.*)$ http://www.haoxianghuo.me/$1 permanent;
		}
				
 #                if ($http_user_agent ~* (Baidu-YunGuanCe-SLABot(ce.baidu.com)) {
#     			   return 403;
#    			}
		location / {  
			include /usr/local/nginx/conf/proxy.conf;		
			proxy_pass http://10.170.108.190:8084; 			
		}
		
		#缓存清理
		include /usr/local/nginx/conf/purge.conf;		
	
		
		#若是静态文件就从nginx缓存从拿取
		location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css|ico){
			include /usr/local/nginx/conf/static.conf;
			if ( !-e $request_filename) {
				 proxy_pass http://10.170.108.190:8084;	
			}
		}
		


	} 
	
	


	
	#移动网站
	include /usr/local/nginx/conf/vhost-m.xianghuo.me.conf;		
			
		
	#运营管理系统
	include /usr/local/nginx/conf/vhost-oss.xianghuo.me.conf;	

	
	
	#BMHC系统
	server{  
		listen       80;  
		server_name  bmhc.xianghuo.me;
		include /usr/local/nginx/conf/errorpages.conf;

		location / {
			include /usr/local/nginx/conf/proxy.conf;
			proxy_pass http://10.170.108.190:8082; 			
		} 
	} 

	
		
		
	#图片（静态）服务器
	server{  	
		listen       80;  
		server_name  static.xianghuo.me src.static.xianghuo.me;     
		include /usr/local/nginx/conf/errorpages.conf;
  
		location / {  			
			include /usr/local/nginx/conf/proxy.conf;
			proxy_pass http://10.170.108.190:8080; 
		}
		
		#若是静态文件就从nginx缓存从拿取
		location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|html|htm|css|ico){		
			include /usr/local/nginx/conf/static.conf;		
			#远程图片被映射到nginx服务器目录下
			root /home/wwwroot/xhw-upload/ROOT/;			
			#request_filename 只会搜索root下的文件
			if ( !-e $request_filename) {
				proxy_pass http://10.170.108.190:8080;
			}
			
		}
		
		

		#清除静态缓存
		#location ~ /purge(/.*)  {  
		#    allow 192.168.0.0/24;  
		#	deny all;  
		#	proxy_cache_purge imgcache $host:$server_port$1$is_args$args;  
		#}
			
	} 
			
		
		
		
		
	#错误中心
	server{  
		listen  80;  
		server_name  error.xianghuo.me ;
		include /usr/local/nginx/conf/errorpages.conf;
		include /usr/local/nginx/conf/static.conf;
		root /usr/local/nginx/html;
		index index.html;
	} 			
		
		
	#支付宝\微信回调(dev)
	server{  
		listen       80;  
		server_name  mdev.xianghuo.me api.92xhw.com;
		location / {
			proxy_connect_timeout   5;
			proxy_send_timeout      30;
			proxy_read_timeout      30;
			proxy_pass http://222.244.144.162:8081; 
		}  
	} 	
	
	#前台(test)
	server{  
		listen       80;  
		server_name  mtest.xianghuo.me;
		location / {
			proxy_connect_timeout   10;
			proxy_send_timeout      100;
			proxy_read_timeout      100;
			proxy_pass http://222.244.144.162:5555; 
		}  
	} 	
		
		
} 	
	
#/usr/local/nginx/conf/nginx.conf
#/usr/local/nginx/sbin/nginx -t
#ps -ef|grep nginx |grep -v grep|cut -c 9-15|xargs kill -9
